<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Activity Tracker</title>
    <!-- React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.FirebaseSDK = { initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc };
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        input[type="datetime-local"] { min-height: 3.5rem; -webkit-appearance: none; border-radius: 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 overscroll-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCP6B9_DJ9MnbqJyKpcu4zv14SPOuOIdeQ",
            authDomain: "fun-time-tracker.firebaseapp.com",
            projectId: "fun-time-tracker",
            storageBucket: "fun-time-tracker.firebasestorage.app",
            messagingSenderId: "865286721478",
            appId: "1:865286721478:web:b69cc2df0dd596217dacc7"
        };
        const APP_ID = "fun-time-tracker-v1";

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const getNowForInput = () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        };

        const FormContent = ({ data, onChange, onToggle }) => {
            const isManual = data.category === 'Manual';
            return (
                <div className="space-y-6 text-left">
                    <div className="relative">
                        <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest flex items-center gap-1">
                            <Icon name="calendar" size={12} /> Date & Time
                        </label>
                        <input 
                            type="datetime-local"
                            value={data.date}
                            onChange={(e) => onChange({...data, date: e.target.value})}
                            className="w-full bg-slate-50 border-2 border-slate-100 p-4 font-bold focus:border-blue-500 outline-none transition-all text-slate-700"
                        />
                    </div>
                    <div className={`grid ${isManual ? 'grid-cols-1' : 'grid-cols-2'} gap-4`}>
                        {!isManual && (
                            <div className="relative">
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">Status</label>
                                <select 
                                    value={data.asked}
                                    onChange={(e) => onChange({...data, asked: e.target.value})}
                                    className="w-full bg-slate-50 border-2 border-slate-100 p-4 font-bold focus:border-blue-500 outline-none appearance-none transition-all text-slate-700"
                                >
                                    <option>Asked</option>
                                    <option>Did Not Ask</option>
                                </select>
                            </div>
                        )}
                        <div className="relative">
                            <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">
                                {isManual ? 'Type' : 'Planning'}
                            </label>
                            <select 
                                value={data.planned}
                                onChange={(e) => onChange({...data, planned: e.target.value})}
                                className="w-full bg-slate-50 border-2 border-slate-100 p-4 font-bold focus:border-blue-500 outline-none appearance-none transition-all text-slate-700"
                            >
                                <option value="Planned">{isManual ? 'P' : 'Planned'}</option>
                                <option value="Not Planned">{isManual ? 'No P' : 'Not Planned'}</option>
                            </select>
                        </div>
                    </div>
                    {data.category === 'Received' && (
                        <div className="animate-fade">
                            <label className="block text-[10px] font-black text-slate-400 uppercase mb-3 ml-1 tracking-widest">Details</label>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.keys(data.details).map(key => (
                                    <button 
                                        key={key}
                                        type="button"
                                        onClick={() => onToggle(key)}
                                        className={`flex items-center justify-between p-4 rounded-2xl border-2 transition-all font-bold active:scale-95 ${data.details[key] ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-100 text-slate-600'}`}
                                    >
                                        <span className="text-sm truncate">{key}</span>
                                        {data.details[key] ? <Icon name="check" size={14} /> : <div className="w-4 h-4 rounded-full border border-slate-200"></div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    {data.category === 'Did Not Receive' && (
                        <div className="animate-fade">
                            <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">Notes</label>
                            <textarea 
                                value={data.notes}
                                onChange={(e) => onChange({...data, notes: e.target.value})}
                                className="w-full bg-slate-50 border-2 border-slate-100 p-4 h-32 focus:border-red-400 outline-none text-lg transition-all"
                                placeholder="Details..."
                            />
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [authError, setAuthError] = useState(null);
            
            const [showDnrModal, setShowDnrModal] = useState(false);
            const [showRecModal, setShowRecModal] = useState(false);
            const [showManualModal, setShowManualModal] = useState(false);
            const [editingId, setEditingId] = useState(null);

            const initialFormState = {
                category: '', asked: 'Asked', planned: 'Planned', date: getNowForInput(), notes: '',
                details: { Him: false, Her: false, Both: false, 'Multiple Times': false, GH: false, RH: false, SV: false, SB: false, T: false, NT: false }
            };
            const [formData, setFormData] = useState(initialFormState);

            // 1. Auth Listener
            useEffect(() => {
                const { initializeApp, getAuth, onAuthStateChanged } = window.FirebaseSDK;
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Sync
            useEffect(() => {
                if (!user) return;
                const { getFirestore, collection, onSnapshot } = window.FirebaseSDK;
                const db = getFirestore();
                
                const colRef = collection(db, 'artifacts', APP_ID, 'users', user.uid, 'entries');
                
                const unsubscribe = onSnapshot(colRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setEntries(data);
                });
                return () => unsubscribe();
            }, [user]);

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError(null);
                const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.FirebaseSDK;
                const auth = getAuth();
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, authEmail, authPassword);
                    } else {
                        await signInWithEmailAndPassword(auth, authEmail, authPassword);
                    }
                } catch (err) {
                    setAuthError(err.message.replace('Firebase:', ''));
                }
            };

            const handleSignOut = () => {
                const { getAuth, signOut } = window.FirebaseSDK;
                signOut(getAuth());
                setEntries([]);
            };

            const resetForm = (category = '') => {
                setFormData({ ...initialFormState, category, date: getNowForInput() });
            };

            const handleAddEntry = async (category) => {
                const id = Date.now().toString();
                const newEntry = { 
                    ...formData, category, 
                    timestamp: new Date(formData.date).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) 
                };

                const { getFirestore, doc, setDoc, collection } = window.FirebaseSDK;
                const db = getFirestore();
                const ref = doc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'entries'), id);
                await setDoc(ref, newEntry);
                
                setShowDnrModal(false); setShowRecModal(false); setShowManualModal(false);
                resetForm();
            };

            const deleteEntry = async (id) => {
                if (!window.confirm("Delete entry?")) return;
                const { getFirestore, doc, deleteDoc, collection } = window.FirebaseSDK;
                const ref = doc(collection(getFirestore(), 'artifacts', APP_ID, 'users', user.uid, 'entries'), id);
                await deleteDoc(ref);
            };

            const saveEdit = async () => {
                const updated = { ...formData, timestamp: new Date(formData.date).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) };
                const { getFirestore, doc, setDoc, collection } = window.FirebaseSDK;
                const ref = doc(collection(getFirestore(), 'artifacts', APP_ID, 'users', user.uid, 'entries'), editingId);
                await setDoc(ref, updated);
                setEditingId(null);
                resetForm();
            };

            const exportToCSV = () => {
                const headers = ["Date", "Category", "Asked/Not", "Planned/Not", "Notes", "Him", "Her", "Both", "Multiple Times", "GH", "RH", "SV", "SB", "T", "NT"];
                const rows = entries.map(e => [
                    `"${e.date}"`, `"${e.category}"`, `"${e.asked}"`, `"${e.planned}"`, `"${e.notes || ''}"`,
                    e.details?.Him ? "X" : "", e.details?.Her ? "X" : "", e.details?.Both ? "X" : "", e.details?.['Multiple Times'] ? "X" : "",
                    e.details?.GH ? "X" : "", e.details?.RH ? "X" : "", e.details?.SV ? "X" : "", e.details?.SB ? "X" : "",
                    e.details?.T ? "X" : "", e.details?.NT ? "X" : ""
                ]);
                const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `tracker_export_${user.email.split('@')[0]}.csv`);
                link.click();
            };

            const Modal = ({ title, isOpen, onClose, onSave, children, saveLabel = "Confirm" }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-end md:items-center justify-center z-50 p-0 md:p-4">
                        <div className="bg-white rounded-t-[2.5rem] md:rounded-3xl shadow-2xl w-full max-w-lg max-h-[92vh] flex flex-col overflow-hidden animate-slide-up">
                            <div className="px-6 pt-7 pb-4 flex justify-between items-center bg-white border-b border-slate-50">
                                <h3 className="text-2xl font-black text-slate-800 tracking-tight">{title}</h3>
                                <button onClick={onClose} className="p-3 bg-slate-100 text-slate-400 rounded-full active:scale-90 transition-all"><Icon name="x" size={20} /></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1 overscroll-contain pb-20">{children}</div>
                            <div className="px-6 py-6 bg-white border-t border-slate-50 flex flex-col md:flex-row gap-3">
                                <button onClick={onSave} className="w-full md:order-2 px-6 py-4 bg-blue-600 text-white rounded-2xl font-black text-lg active:scale-95 shadow-xl shadow-blue-200 flex items-center justify-center gap-2">
                                    <Icon name="check-circle" size={20} /> {saveLabel}
                                </button>
                                <button onClick={onClose} className="w-full md:order-1 px-6 py-4 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition-all">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-white font-black text-slate-200 text-3xl">TRACKER...</div>;

            if (!user) {
                return (
                    <div className="min-h-screen bg-white flex flex-col items-center justify-center px-6">
                        <div className="w-full max-w-sm space-y-8 animate-fade">
                            <div className="text-center">
                                <h1 className="text-5xl font-black tracking-tighter mb-2">TRACKER</h1>
                                <p className="text-slate-400 font-bold text-xs uppercase tracking-[0.2em]">Secure Cloud Login</p>
                            </div>
                            <form onSubmit={handleAuth} className="space-y-4">
                                {authError && <div className="bg-red-50 text-red-500 p-4 rounded-2xl text-xs font-bold border border-red-100">{authError}</div>}
                                <div className="space-y-2">
                                    <input type="email" value={authEmail} onChange={(e) => setAuthEmail(e.target.value)} placeholder="Email address" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-5 outline-none focus:border-blue-500 font-bold" required />
                                    <input type="password" value={authPassword} onChange={(e) => setAuthPassword(e.target.value)} placeholder="Password" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-5 outline-none focus:border-blue-500 font-bold" required />
                                </div>
                                <button type="submit" className="w-full bg-slate-900 text-white rounded-2xl p-5 font-black text-lg shadow-xl shadow-slate-200 active:scale-95 transition-all">
                                    {isRegistering ? 'Create Account' : 'Sign In'}
                                </button>
                                <button type="button" onClick={() => setIsRegistering(!isRegistering)} className="w-full text-slate-400 font-bold text-sm">
                                    {isRegistering ? 'Already have an account? Login' : 'New user? Create an account'}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 px-4 pt-8 md:pt-12 max-w-5xl mx-auto animate-fade">
                    <header className="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-8 text-center md:text-left">
                        <div>
                            <h1 className="text-6xl font-black tracking-tighter text-slate-900 leading-none">TRACKER</h1>
                            <div className="flex items-center justify-center md:justify-start gap-3 mt-2">
                                <span className="text-[10px] font-black px-2 py-1 rounded bg-emerald-500 text-white uppercase tracking-widest">Connected</span>
                                <button onClick={handleSignOut} className="text-[10px] font-black text-slate-400 hover:text-red-500 uppercase tracking-widest transition-all">
                                    Logout ({user.email.split('@')[0]})
                                </button>
                            </div>
                        </div>
                        <button onClick={exportToCSV} disabled={entries.length === 0} className="flex items-center justify-center gap-3 bg-slate-900 hover:bg-black active:scale-95 text-white px-8 py-5 rounded-[2rem] font-black text-sm shadow-xl transition-all disabled:opacity-30">
                            <Icon name="download" size={18} /> EXPORT RESULTS
                        </button>
                    </header>

                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-5 mb-12">
                        <button onClick={() => { resetForm('Manual'); setShowManualModal(true); }} className="group flex flex-col items-center justify-center bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm active:scale-[0.97] hover:border-indigo-400 transition-all">
                            <div className="p-6 rounded-[1.5rem] bg-indigo-50 text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition-all shadow-sm"><Icon name="edit-3" size={40} /></div>
                            <h2 className="text-xl font-black tracking-tight text-slate-800 mt-4 uppercase tracking-wider">Manual</h2>
                        </button>
                        <button onClick={() => { resetForm('Did Not Receive'); setShowDnrModal(true); }} className="group flex flex-col items-center justify-center bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm active:scale-[0.97] hover:border-red-400 transition-all">
                            <div className="p-6 rounded-[1.5rem] bg-red-50 text-red-500 group-hover:bg-red-500 group-hover:text-white transition-all shadow-sm"><Icon name="slash" size={40} /></div>
                            <h2 className="text-xl font-black tracking-tight text-slate-800 mt-4 uppercase tracking-wider">No Result</h2>
                        </button>
                        <button onClick={() => { resetForm('Received'); setShowRecModal(true); }} className="group flex flex-col items-center justify-center bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm active:scale-[0.97] hover:border-blue-400 transition-all">
                            <div className="p-6 rounded-[1.5rem] bg-blue-50 text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-all shadow-sm"><Icon name="check-circle" size={40} /></div>
                            <h2 className="text-xl font-black tracking-tight text-slate-800 mt-4 uppercase tracking-wider text-center leading-tight text-blue-600">Received</h2>
                        </button>
                    </div>

                    <div className="mb-6 flex items-center justify-between px-2 text-slate-400">
                        <h3 className="text-[10px] font-black tracking-[0.4em] uppercase flex items-center gap-2"><Icon name="list" size={14} /> Log History</h3>
                        <div className="h-[1px] flex-1 mx-4 bg-slate-200"></div>
                        <span className="text-[10px] font-black px-3 py-1 bg-slate-900 text-white rounded-full tracking-widest">{entries.length} RECORDS</span>
                    </div>

                    <div className="space-y-4 pb-20">
                        {entries.length === 0 ? (
                            <div className="bg-white rounded-[2rem] p-16 text-center border-2 border-dashed border-slate-200 text-slate-300 font-bold italic tracking-wide">Ready to track. Sign in on your other device to sync.</div>
                        ) : (
                            entries.map((entry) => (
                                <div key={entry.id} className="bg-white rounded-[2rem] p-7 shadow-sm border border-slate-100 hover:shadow-md transition-all group animate-fade">
                                    <div className="flex justify-between items-start gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-3">
                                                <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full text-white ${entry.category === 'Received' ? 'bg-blue-600' : entry.category === 'Manual' ? 'bg-indigo-600' : 'bg-red-500'}`}>{entry.category}</span>
                                                <span className="text-[10px] font-bold text-slate-300 uppercase tracking-tighter">{entry.timestamp}</span>
                                            </div>
                                            <h4 className="font-black text-2xl text-slate-800 flex items-center flex-wrap gap-x-2 mb-4">
                                                {entry.category !== 'Manual' ? entry.asked : 'Manual Entry'}
                                                <Icon name="arrow-right" size={16} className="text-slate-200" />
                                                <span className="text-slate-400">{entry.category === 'Manual' ? (entry.planned === 'Planned' ? 'P' : 'No P') : entry.planned}</span>
                                            </h4>
                                            <div className="space-y-3">
                                                {entry.details && Object.entries(entry.details).some(([_,v]) => v) && (
                                                    <div className="flex flex-wrap gap-2">
                                                        {Object.entries(entry.details).filter(([_,v]) => v).map(([k]) => <span key={k} className="bg-slate-50 text-slate-600 text-[10px] px-3 py-1.5 rounded-xl font-black uppercase border border-slate-100">{k}</span>)}
                                                    </div>
                                                )}
                                                {entry.notes && <div className="bg-slate-50 p-4 rounded-2xl border-l-4 border-slate-200 text-slate-600 text-sm italic leading-relaxed">"{entry.notes}"</div>}
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <button onClick={() => { startEditing(entry); if (entry.category === 'Manual') setShowManualModal(true); else if (entry.category === 'Received') setShowRecModal(true); else setShowDnrModal(true); }} className="p-4 text-slate-300 hover:text-blue-600 hover:bg-blue-50 rounded-2xl transition-all active:scale-90"><Icon name="edit-3" size={24} /></button>
                                            <button onClick={() => deleteEntry(entry.id)} className="p-4 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-2xl transition-all active:scale-90"><Icon name="trash-2" size={24} /></button>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <Modal title={`Modify Entry`} isOpen={editingId !== null} onClose={() => { setEditingId(null); resetForm(); }} onSave={saveEdit}><FormContent data={formData} onChange={setFormData} onToggle={(key) => setFormData(p => ({...p, details: {...p.details, [key]: !p.details[key]}}))} /></Modal>
                    <Modal title="Manual Record" isOpen={showManualModal && !editingId} onClose={() => setShowManualModal(false)} onSave={() => handleAddEntry('Manual')}><FormContent data={{...formData, category: 'Manual'}} onChange={setFormData} onToggle={(key) => setFormData(p => ({...p, details: {...p.details, [key]: !p.details[key]}}))} /></Modal>
                    <Modal title="Report: No Result" isOpen={showDnrModal && !editingId} onClose={() => setShowDnrModal(false)} onSave={() => handleAddEntry('Did Not Receive')}><FormContent data={{...formData, category: 'Did Not Receive'}} onChange={setFormData} onToggle={(key) => setFormData(p => ({...p, details: {...p.details, [key]: !p.details[key]}}))} /></Modal>
                    <Modal title="Report: Received" isOpen={showRecModal && !editingId} onClose={() => setShowRecModal(false)} onSave={() => handleAddEntry('Received')}><FormContent data={{...formData, category: 'Received'}} onChange={setFormData} onToggle={(key) => setFormData(p => ({...p, details: {...p.details, [key]: !p.details[key]}}))} /></Modal>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
